/* eslint-disable */
function t(){}function s(){throw"@wareset/store: cycle detected"}const i=Object.is||function(t,s){return t===s?0!==t||1/t==1/s:t!=t&&s!=s};let h=[];let n=null;function e(t){for(let s=t.length;s-- >0;)t[s].a=!0,e(t[s].s._.w)}let l,u={};class Computed{constructor(t,s){this.s=t,this.f=s,this.i=[],this.x=[],this.g=null,this.a=!0,this.u=!0,this.m=null,this.l=0;let i=0;const h=this;this.cb=function(){0===h.l&&u!==h.g&&h.a&&(i<=0&&(i=function(t){let s=0;for(let i=t.x.length;i-- >0;)t.i[i]._.c&&t.i[i]._.c.tt(),t.x[i].v!==t.i[i]._.v&&s++;return s}(h)),0==--i&&(h.u=!0,h.tt()))}}ps(){if(0===this.l){if(this.l++,this.g=u,this.u){this.m=u;const t=n;n=this,this.f(this.s._value),n=t}for(let t=this.x.length;t-- >0;)this.i[t]._.c&&this.i[t]._.c.tt(),this.x[t].v=this.i[t]._.v,this.x[t].m,this.m;this.a=!1,this.u=!1,this.l--}}tt(){if(0!==this.l||u===this.g||!this.a&&this.s._.s.n!==this.s._.s)this.l>0&&this.u&&s();else{const t=n;if(n=null,this.l++,this.g=u,!this.u)for(let s=this.x.length;s-- >0;)if(this.i[s]._.c&&this.i[s]._.c.tt(),this.x[s].v!==this.i[s]._.v){this.u=!0;break}if(this.u){this.m=u,this.a=!1,n=this;const t=this.f(this.s._value);n=null;for(let s=this.x.length;s-- >0;)this.x[s].m===this.m?this.x[s].v=this.i[s]._.v:(this.x.splice(s,1)[0].u(),this.i.splice(s,1));this.u=!1,this.s.set(t,this.s._.r(o))}this.l--,n=t}}sb(t){const s=this,i=t._.w;i.push(s);const h=t.subscribe(s.cb);return function(){const t=i.lastIndexOf(s);t>-1&&i.splice(t,1),h()}}it(s){if(s!==this.s){this.l++;const i=this.i.indexOf(s),h=this.s._.s.n!==this.s._.s;i<0?(this.i.push(s),this.x.push({m:this.m,v:this.s._.v,u:h?this.sb(s):t})):(h&&this.x[i].u===t&&(this.x[i].u=this.sb(s)),this.x[i].m=this.m),this.l--}}un(){for(let s=this.x.length;s-- >0;)this.x[s].u(),this.x[s].u=t}}function o(t){return function(s){return s===o?t:void 0}}class Store{constructor(t,s){this._={i:-1,v:{},s:{p:null,n:null},o:null,w:[],c:s&&s.compute?new Computed(this,s.compute):null,p:s&&s.preset||null,f:s&&s.start||null,l:null,r:o(s?s.pass:void 0)},this._.s.p=this._.s.n=this._.o=this._.s,this._value=t}get $(){return this.get()}set $(t){this.set(t)}get(){const s=this._;n&&n.it(this);const i=s.s.n===s.s?this.subscribe(t):(s.c&&s.c.tt(),null),h=this._value;return i&&i(),h}set(t,n){const l=this._;if(l.r(o)!==n)throw"@wareset/store: pass";var c,r;return l.c&&l.c.ps(),c=this._value,r=l.p?t=l.p(t,this._value):t,(!i(c,r)||c&&("object"==typeof c||"function"==typeof c))&&(this._value=t,u=l.v={},e(l.w),function(t){if(h.length>4e4&&s(),0==(t._.i=h.push(t)-1)){for(let s,i=0;i<h.length;i++)if((s=(t=h[i])._).i===i)for(s.o=s.s;(s.o=s.o.n)!==s.s&&(s.c&&s.c.tt(),s.i===i);)s.o.f.call(t,t._value);h=[]}}(this)),this}subscribe(s){const i=this,h=i._;let n={p:null,n:null,f:t};return h.o=(n.p=(n.n=h.o===h.s?h.s:h.o.n).p).n=n.n.p=n,h.s.n===n&&(h.c&&(h.c.a=!0,h.c.tt()),h.f&&(h.l=h.f(i))),n.f=s,s.call(i,i._value),function(){n&&(n.p.n=n.n,n.n.p=n.p,n.f=t,n=null,h.s.n===h.s&&(h.l&&h.l(i),h.c&&h.c.un()))}}toString(){const t=this.$;return null!=t&&t.toString?t.toString.apply(t,arguments):""+t}valueOf(){const t=this.$;return null!=t&&t.valueOf?t.valueOf.apply(t,arguments):t}toJSON(){const t=this.$;return null!=t&&t.toJSON?t.toJSON.apply(t,arguments):t}}exports.Store=Store,exports.batch=function(t){l||(l=new Store({q:[]}),l.subscribe((function(t){for(;t.q.length>0;)t.q.shift()()}))),l._value.q.push(t),l.set({q:l._value.q})},exports.computed=function(t){return new Store(void 0,{compute:t})},exports.effect=function(s,i){return new Store(void 0,{compute:s}).subscribe(i||t)},exports.store=function(t,s){return new Store(t,s)};
