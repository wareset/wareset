/* eslint-disable */
function t(){}function s(){throw"@wareset/store: cycle detected"}const i=Object.is||function(t,s){return t===s?0!==t||1/t==1/s:t!=t&&s!=s};let n=[];let h=null;function e(t){for(let s=t.length;s-- >0;)t[s].a=!0,e(t[s].s._.w)}let l,u={};class Computed{constructor(t,s){this.s=t,this.f=s,this.i=[],this.x=[],this.g=null,this.a=!0,this.u=!0,this.m=null,this.l=0;let i=0;const n=this;this.cb=function(){0===n.l&&u!==n.g&&n.a&&(i<=0&&(i=function(t){let s=0;for(let i=t.x.length;i-- >0;)t.i[i]._.c&&t.i[i]._.c.tt(),t.x[i].v!==t.i[i]._.v&&s++;return s}(n)),0==--i&&(n.u=!0,n.tt()))}}ps(){if(0===this.l){if(this.l++,this.g=u,this.u){this.m=u;const t=h;h=this,this.f(this.s._value),h=t}for(let t=this.x.length;t-- >0;)this.i[t]._.c&&this.i[t]._.c.tt(),this.x[t].v=this.i[t]._.v,this.x[t].m,this.m;this.a=!1,this.u=!1,this.l--}}tt(){if(0!==this.l||u===this.g||!this.a&&this.s._.s.n!==this.s._.s)this.l>0&&this.u&&s();else{const t=h;if(h=null,this.l++,this.g=u,!this.u)for(let s=this.x.length;s-- >0;)if(this.i[s]._.c&&this.i[s]._.c.tt(),this.x[s].v!==this.i[s]._.v){this.u=!0;break}if(this.u){this.m=u,this.a=!1,h=this;const t=this.f(this.s._value);h=null;for(let s=this.x.length;s-- >0;)this.x[s].m===this.m?this.x[s].v=this.i[s]._.v:(this.x.splice(s,1)[0].u(),this.i.splice(s,1));this.u=!1,this.s.set(t,this.s._.r(o))}this.l--,h=t}}sb(t){const s=this,i=t._.w;i.push(s);const n=t.subscribe(s.cb);return function(){const t=i.lastIndexOf(s);t>-1&&i.splice(t,1),n()}}it(s){if(s!==this.s){this.l++;const i=this.i.indexOf(s),n=this.s._.s.n!==this.s._.s;i<0?(this.i.push(s),this.x.push({m:this.m,v:this.s._.v,u:n?this.sb(s):t})):(n&&this.x[i].u===t&&(this.x[i].u=this.sb(s)),this.x[i].m=this.m),this.l--}}un(){for(let s=this.x.length;s-- >0;)this.x[s].u(),this.x[s].u=t}}function o(t){return function(s){return s===o?t:void 0}}class Store{constructor(t,s){this._={i:-1,v:{},s:{p:null,n:null},o:null,w:[],c:s&&s.compute?new Computed(this,s.compute):null,p:s&&s.preset||null,f:s&&s.start||null,l:null,r:o(s?s.pass:void 0)},this._.s.p=this._.s.n=this._.o=this._.s,this._value=t}get $(){return this.get()}set $(t){this.set(t)}get(){const s=this._;h&&h.it(this);const i=s.s.n===s.s?this.subscribe(t):(s.c&&s.c.tt(),null),n=this._value;return i&&i(),n}set(t,h){const l=this._;if(l.r(o)!==h)throw"@wareset/store: pass";var c,r;return l.c&&l.c.ps(),c=this._value,r=l.p?t=l.p(t,this._value):t,(!i(c,r)||c&&("object"==typeof c||"function"==typeof c))&&(this._value=t,u=l.v={},e(l.w),function(t){if(n.length>4e4&&s(),0==(t._.i=n.push(t)-1)){for(let s,i=0;i<n.length;i++)if((s=(t=n[i])._).i===i)for(s.o=s.s;(s.o=s.o.n)!==s.s&&(s.c&&s.c.tt(),s.i===i);)s.o.f.call(t,t._value);n=[]}}(this)),this}subscribe(s){const i=this,n=i._;let h={p:null,n:null,f:t};return n.o=(h.p=(h.n=n.o===n.s?n.s:n.o.n).p).n=h.n.p=h,n.s.n===h&&(n.c&&(n.c.a=!0,n.c.tt()),n.f&&(n.l=n.f(i))),h.f=s,s.call(i,i._value),function(){h&&(h.p.n=h.n,h.n.p=h.p,h.f=t,h=null,n.s.n===n.s&&(n.l&&n.l(i),n.c&&n.c.un()))}}toString(){const t=this.$;return null!=t&&t.toString?t.toString.apply(t,arguments):""+t}valueOf(){const t=this.$;return null!=t&&t.valueOf?t.valueOf.apply(t,arguments):t}toJSON(){const t=this.$;return null!=t&&t.toJSON?t.toJSON.apply(t,arguments):t}}function c(t,s){return new Store(t,s)}function r(t){l||(l=new Store({q:[]}),l.subscribe((function(t){for(;t.q.length>0;)t.q.shift()()}))),l._value.q.push(t),l.set({q:l._value.q})}function f(t){return new Store(void 0,{compute:t})}function p(s,i){return new Store(void 0,{compute:s}).subscribe(i||t)}export{Store,r as batch,f as computed,p as effect,c as store};
